# avito-pr-api
avito-pr-api

# о чем упомянуть

- логирование зап (логируются только серверные ошибки)
- грейсфул шатдаун
- миграции с помощью контейнера
- фрейворк джин
- слоистая архитектура
- индексация таблиц
- сделал в таблице тим отдельное поле айди, для удобной работы с бд (хотя и придется попотеть в бизнес логике)
- для проверки токенов создан мидлвейр заглушка, который в будущем можно будет переписать для проверки роли юзера, 
поэтому нужно что нибудь передавать в заголовке авторизации (только в тех ручках, где требуется токен)
- сгенерировал типы по предложенной апишке
- контексты из реквеста передаются вниз по всем слоям, для коннекта используется контекст с таймаутом
- енв экзампл надо переименовать и рекомендуется оставить те данные которые там находятся
- в условиях сказано что в пр есть флаг нид мор ревьюерс, но что с ним делать не сказано (в апишке тоже про него 
ни слова). я сделал что этот флаг у пр 
по дефолту фолс, становится в тру когда не хватает ревьюеров при assignedReviewers 
- добавил несколько своих ошибок (для 400 и 500)
- не понял зачем нужна ошибка no_candidate, ведь если нам не хватает кандидатов на ревьюера мы же не будет ложиться
с ошибкой, а просто ставим флаг что пру нужны ревьюеры
- для пр сделал уникальный идентификатор, так как если они будут повторяться будет путаница (например при MergePR 
закроются все пр со статусом опен и таким айди). в некоторых ручках передается только айди, поэтому будет непонятно
- PRLifecycleDurationHours отслеживает время жизни PR от создания до мерджа в часах
- написал юнит тесты для сервисного и сторедж слоев, а так же для технических методов в утилс
минимум 75 процентов покрытия
- интеграционный тест полностью проверяет флоу пул реквеста (возможно понадобится выключить процесс, который
занимает 5432 порт)
- 

  // TestIntegrationPullRequestFlow проверяет полный цикл работы с PR:
  // 1. Создание команды
  // 2. Создание пользователей (автор + 2 ревьювера)
  // 3. Создание PR
  // 4. Автоматическое назначение ревьюеров
  // 5. Мердж PR
  // 6. Проверка корректности состояния



# осталось: 
- деактивация,
- нагрузочное тестирование, 
- хорошая ридмишка


# можно добавить для прометея

### 3. Полезные PromQL запросы

**Среднее время жизни PR (за последние 5 минут):**
```promql
rate(pr_lifecycle_duration_hours_sum[5m]) / rate(pr_lifecycle_duration_hours_count[5m])
```

**Медианное время (p50):**
```promql
histogram_quantile(0.5, rate(pr_lifecycle_duration_hours_bucket[5m]))
```

**95-й перцентиль (p95):**
```promql
histogram_quantile(0.95, rate(pr_lifecycle_duration_hours_bucket[5m]))
```

**Количество PR, закрытых за последний час:**
```promql
increase(pr_lifecycle_duration_hours_count[1h])
```

**Процент PR, закрытых быстрее 24 часов:**
```promql
sum(rate(pr_lifecycle_duration_hours_bucket{le="24"}[5m])) 
/ 
sum(rate(pr_lifecycle_duration_hours_count[5m])) * 100
```
